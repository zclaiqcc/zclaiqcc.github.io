<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="articles for tech &amp; life &amp; thoughts"><title>Tornado Note | Marktub</title><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Raleway:400,300,600"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Tornado Note</h1><a id="logo" href="/.">Marktub</a><p class="description">Do not go gentle into that good night.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">Tornado Note</h1><div class="post-meta">2019-08-13<span> | </span><span class="category"><a href="/categories/notes/">notes</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Major-Components"><span class="toc-number">1.1.</span> <span class="toc-text">4 Major Components</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asynchronous-and-non-Blocking-I-O"><span class="toc-number">2.</span> <span class="toc-text">Asynchronous and non-Blocking I&#x2F;O</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Blocking"><span class="toc-number">2.1.</span> <span class="toc-text">Blocking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Asynchronous"><span class="toc-number">2.2.</span> <span class="toc-text">Asynchronous</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Coroutines"><span class="toc-number">3.</span> <span class="toc-text">Coroutines</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tornado-web-application"><span class="toc-number">4.</span> <span class="toc-text">Tornado web application</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Application-object"><span class="toc-number">4.1.</span> <span class="toc-text">The Application object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Subclassing-RequestHandler"><span class="toc-number">4.2.</span> <span class="toc-text">Subclassing RequestHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handling-request-input"><span class="toc-number">4.3.</span> <span class="toc-text">Handling request input</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Overriding-RequestHandler-methods"><span class="toc-number">4.4.</span> <span class="toc-text">Overriding RequestHandler methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Asynchronous-handlers"><span class="toc-number">4.5.</span> <span class="toc-text">Asynchronous handlers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Running-and-deploying"><span class="toc-number">5.</span> <span class="toc-text">Running and deploying</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Running-behind-a-load-balancer"><span class="toc-number">5.1.</span> <span class="toc-text">Running behind a load balancer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-framework"><span class="toc-number">6.</span> <span class="toc-text">Web framework</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tornado-web-—-RequestHandler-and-Application-classes"><span class="toc-number">6.1.</span> <span class="toc-text">tornado.web — RequestHandler and Application classes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tornado-routing-—-Basic-routing-implementation"><span class="toc-number">6.2.</span> <span class="toc-text">tornado.routing — Basic routing implementation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tornado-websocket-—-Bidirectional-communication-to-the-browser"><span class="toc-number">6.3.</span> <span class="toc-text">tornado.websocket — Bidirectional communication to the browser</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-servers-and-clients"><span class="toc-number">7.</span> <span class="toc-text">HTTP servers and clients</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tornado-httpserver-—-Non-blocking-HTTP-server"><span class="toc-number">7.1.</span> <span class="toc-text">tornado.httpserver — Non-blocking HTTP server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tornado-httpclient-—-Asynchronous-HTTP-client"><span class="toc-number">7.2.</span> <span class="toc-text">tornado.httpclient — Asynchronous HTTP client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asynchronous-networking"><span class="toc-number">8.</span> <span class="toc-text">Asynchronous networking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tornado-ioloop-—-Main-event-loop"><span class="toc-number">8.1.</span> <span class="toc-text">tornado.ioloop — Main event loop</span></a></li></ol></li></ol></div></div><div class="post-content"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><blockquote>
<p>Tornado is a Python web framework and asynchronous networking library</p>
</blockquote>
<h3 id="4-Major-Components"><a href="#4-Major-Components" class="headerlink" title="4 Major Components"></a>4 Major Components</h3><ul>
<li>A web framework: <code>RequestHandler</code> and various supporting classes</li>
<li>Client- and server-side implementions of HTTP: <code>HTTPServer</code> and <code>AsyncHTTPClient</code></li>
<li>An asynchronous networking library: <code>IOLoop</code> and <code>IOStream</code></li>
<li>A coroutine library: <code>tornado.gen</code>. But after Python3.5, <code>async def</code> is recommended.</li>
</ul>
<h2 id="Asynchronous-and-non-Blocking-I-O"><a href="#Asynchronous-and-non-Blocking-I-O" class="headerlink" title="Asynchronous and non-Blocking I/O"></a>Asynchronous and non-Blocking I/O</h2><h3 id="Blocking"><a href="#Blocking" class="headerlink" title="Blocking"></a>Blocking</h3><blockquote>
<p>In fact, every function blocks, at least a little bit, while it is running and using the CPU</p>
</blockquote>
<h3 id="Asynchronous"><a href="#Asynchronous" class="headerlink" title="Asynchronous"></a>Asynchronous</h3><blockquote>
<p>An asynchronous function returns before it is finished, and generally causes some work to happen in the background before triggering some future action in the application</p>
</blockquote>
<ul>
<li>Callback argument</li>
<li>Return a placeholder (<code>Future</code>, <code>Promise</code>, <code>Deferred</code>)</li>
<li>Deliver to a queue</li>
<li>Callback registry (e.g. POSIX signals)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tornado.concurrent <span class="keyword">import</span> Future</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">async_fetch_manual</span><span class="params">(url)</span>:</span></span><br><span class="line">    http_client = AsyncHTTPClient()</span><br><span class="line">    my_future = Future()</span><br><span class="line">    fetch_future = http_client.fetch(url)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_fetch</span><span class="params">(f)</span>:</span></span><br><span class="line">        my_future.set_result(f.result().body)</span><br><span class="line">    fetch_future.add_done_callback(on_fetch)</span><br><span class="line">    <span class="keyword">return</span> my_future</span><br></pre></td></tr></table></figure>

<h2 id="Coroutines"><a href="#Coroutines" class="headerlink" title="Coroutines"></a>Coroutines</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Simplified inner loop of tornado.gen.Runner</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># send(x) makes the current yield return x.</span></span><br><span class="line">    <span class="comment"># It returns when the next yield is reached</span></span><br><span class="line">    future = self.gen.send(self.next)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(f)</span>:</span></span><br><span class="line">        self.next = f.result()</span><br><span class="line">        self.run()</span><br><span class="line">    future.add_done_callback(callback)</span><br></pre></td></tr></table></figure>

<h2 id="Tornado-web-application"><a href="#Tornado-web-application" class="headerlink" title="Tornado web application"></a>Tornado web application</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">"Hello, world"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_app</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> tornado.web.Application([</span><br><span class="line">        (<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app = make_app()</span><br><span class="line">    app.listen(<span class="number">8888</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.current().start()</span><br></pre></td></tr></table></figure>

<h3 id="The-Application-object"><a href="#The-Application-object" class="headerlink" title="The Application object"></a>The <code>Application</code> object</h3><h3 id="Subclassing-RequestHandler"><a href="#Subclassing-RequestHandler" class="headerlink" title="Subclassing RequestHandler"></a>Subclassing <code>RequestHandler</code></h3><h3 id="Handling-request-input"><a href="#Handling-request-input" class="headerlink" title="Handling request input"></a>Handling request input</h3><ul>
<li>get_argument</li>
<li>get_arguments</li>
<li>get_body_argument</li>
<li>get_body_arguments</li>
</ul>
<h3 id="Overriding-RequestHandler-methods"><a href="#Overriding-RequestHandler-methods" class="headerlink" title="Overriding RequestHandler methods"></a>Overriding RequestHandler methods</h3><p><code>prepare</code>, <code>get</code>, <code>post</code>, <code>initialize</code>, <code>on_finish</code>, <code>on_connection_close</code>, <code>set_default_headers</code></p>
<h3 id="Asynchronous-handlers"><a href="#Asynchronous-handlers" class="headerlink" title="Asynchronous handlers"></a>Asynchronous handlers</h3><p>override <code>get</code>/<code>post</code>/etc to make the handler asynchronous</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        http = tornado.httpclient.AsyncHTTPClient()</span><br><span class="line">        response = <span class="keyword">await</span> http.fetch(<span class="string">"http://friendfeed-api.com/v2/feed/bret"</span>)</span><br><span class="line">        json = tornado.escape.json_decode(response.body)</span><br><span class="line">        self.write(<span class="string">"Fetched "</span> + str(len(json[<span class="string">"entries"</span>])) + <span class="string">" entries "</span></span><br><span class="line">                   <span class="string">"from the FriendFeed API"</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Running-and-deploying"><a href="#Running-and-deploying" class="headerlink" title="Running and deploying"></a>Running and deploying</h2><blockquote>
<p>Due to the Python GIL (Global Interpreter Lock), it is necessary to run multiple Python processes to take full advantage of multi-CPU machines. Typically it is best to run one process per CPU.</p>
</blockquote>
<h3 id="Running-behind-a-load-balancer"><a href="#Running-behind-a-load-balancer" class="headerlink" title="Running behind a load balancer"></a>Running behind a load balancer</h3><h2 id="Web-framework"><a href="#Web-framework" class="headerlink" title="Web framework"></a>Web framework</h2><h3 id="tornado-web-—-RequestHandler-and-Application-classes"><a href="#tornado-web-—-RequestHandler-and-Application-classes" class="headerlink" title="tornado.web — RequestHandler and Application classes"></a><code>tornado.web</code> — <code>RequestHandler</code> and <code>Application</code> classes</h3><h3 id="tornado-routing-—-Basic-routing-implementation"><a href="#tornado-routing-—-Basic-routing-implementation" class="headerlink" title="tornado.routing — Basic routing implementation"></a><code>tornado.routing</code> — Basic routing implementation</h3><h3 id="tornado-websocket-—-Bidirectional-communication-to-the-browser"><a href="#tornado-websocket-—-Bidirectional-communication-to-the-browser" class="headerlink" title="tornado.websocket — Bidirectional communication to the browser"></a><code>tornado.websocket</code> — Bidirectional communication to the browser</h3><h2 id="HTTP-servers-and-clients"><a href="#HTTP-servers-and-clients" class="headerlink" title="HTTP servers and clients"></a>HTTP servers and clients</h2><h3 id="tornado-httpserver-—-Non-blocking-HTTP-server"><a href="#tornado-httpserver-—-Non-blocking-HTTP-server" class="headerlink" title="tornado.httpserver — Non-blocking HTTP server"></a><code>tornado.httpserver</code> — Non-blocking HTTP server</h3><h3 id="tornado-httpclient-—-Asynchronous-HTTP-client"><a href="#tornado-httpclient-—-Asynchronous-HTTP-client" class="headerlink" title="tornado.httpclient — Asynchronous HTTP client"></a><code>tornado.httpclient</code> — Asynchronous HTTP client</h3><h2 id="Asynchronous-networking"><a href="#Asynchronous-networking" class="headerlink" title="Asynchronous networking"></a>Asynchronous networking</h2><h3 id="tornado-ioloop-—-Main-event-loop"><a href="#tornado-ioloop-—-Main-event-loop" class="headerlink" title="tornado.ioloop — Main event loop"></a><code>tornado.ioloop</code> — Main event loop</h3></div><div class="tags"><a href="/tags/tornado-python/"><i class="fa fa-tag"></i>tornado, python</a></div><div class="post-nav"><a class="pre" href="/2019/08/24/tornado-async-note/">Tornado Async Note</a><a class="next" href="/2019/08/07/how-to-use-git-elegantly/">Git Tutorial (Saloon Script)</a></div></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>